<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Administration - Conception et Prototypage</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            color: #fff;
        }
        
        .header {
            background: rgba(255,255,255,0.1);
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .header h1 {
            font-size: 1.5rem;
            color: #4fc3f7;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        .btn-logout {
            background: #e74c3c;
            color: white;
        }
        
        .btn-logout:hover {
            background: #c0392b;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 80vh;
        }
        
        .login-box {
            background: rgba(255,255,255,0.1);
            padding: 40px;
            border-radius: 16px;
            width: 100%;
            max-width: 400px;
        }
        
        .login-box h2 {
            text-align: center;
            margin-bottom: 30px;
            color: #4fc3f7;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #aaa;
        }
        
        .form-group input {
            width: 100%;
            padding: 12px;
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            background: rgba(255,255,255,0.1);
            color: white;
            font-size: 16px;
        }
        
        .btn-login {
            width: 100%;
            background: #4fc3f7;
            color: #1a1a2e;
            font-weight: bold;
        }
        
        .btn-login:hover {
            background: #29b6f6;
        }
        
        .error-msg {
            color: #e74c3c;
            text-align: center;
            margin-top: 15px;
        }
        
        /* Dashboard Styles */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: rgba(255,255,255,0.1);
            padding: 25px;
            border-radius: 12px;
            text-align: center;
        }
        
        .stat-card h3 {
            font-size: 2.5rem;
            color: #4fc3f7;
            margin-bottom: 10px;
        }
        
        .stat-card p {
            color: #aaa;
            font-size: 0.9rem;
        }
        
        .section {
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .section h2 {
            color: #4fc3f7;
            margin-bottom: 20px;
            font-size: 1.3rem;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            padding-bottom: 10px;
        }
        
        .progress-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
        }
        
        .progress-item {
            background: rgba(255,255,255,0.05);
            padding: 15px;
            border-radius: 8px;
        }
        
        .progress-item h4 {
            margin-bottom: 10px;
            color: #fff;
        }
        
        .progress-bar {
            height: 20px;
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            overflow: hidden;
            position: relative;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4fc3f7, #29b6f6);
            border-radius: 10px;
            transition: width 0.5s ease;
        }
        
        .progress-text {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 12px;
            font-weight: bold;
        }
        
        /* Table Styles */
        .table-container {
            overflow-x: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        th {
            background: rgba(79, 195, 247, 0.2);
            color: #4fc3f7;
            font-weight: 600;
            position: sticky;
            top: 0;
        }
        
        tr:hover {
            background: rgba(255,255,255,0.05);
        }
        
        .badge {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .badge-success {
            background: #27ae60;
            color: white;
        }
        
        .badge-warning {
            background: #f39c12;
            color: white;
        }
        
        .badge-danger {
            background: #e74c3c;
            color: white;
        }
        
        .badge-info {
            background: #3498db;
            color: white;
        }
        
        .note-cell {
            font-weight: bold;
        }
        
        .note-excellent { color: #27ae60; }
        .note-good { color: #f39c12; }
        .note-poor { color: #e74c3c; }
        
        .filters {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .filters select, .filters input {
            padding: 10px 15px;
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            background: rgba(255,255,255,0.1);
            color: white;
            font-size: 14px;
        }
        
        .filters select option {
            background: #1a1a2e;
        }
        
        .examen-status {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }
        
        .examen-badge {
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 11px;
            white-space: nowrap;
        }
        
        .examen-passe {
            background: #27ae60;
        }
        
        .examen-non-passe {
            background: #7f8c8d;
        }
        
        .hidden {
            display: none;
        }
        
        .loading {
            text-align: center;
            padding: 50px;
            color: #aaa;
        }
        
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .tab {
            padding: 10px 20px;
            background: rgba(255,255,255,0.1);
            border: none;
            border-radius: 8px;
            color: #aaa;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .tab.active {
            background: #4fc3f7;
            color: #1a1a2e;
        }
        
        .tab:hover:not(.active) {
            background: rgba(255,255,255,0.2);
        }
    </style>
</head>
<body>
    <!-- Login Section -->
    <div id="loginSection">
        <div class="login-container">
            <div class="login-box">
                <h2>Administration</h2>
                <form id="loginForm">
                    <div class="form-group">
                        <label>Login</label>
                        <input type="text" id="login" required>
                    </div>
                    <div class="form-group">
                        <label>Mot de passe</label>
                        <input type="password" id="password" required>
                    </div>
                    <button type="submit" class="btn btn-login">Connexion</button>
                    <p id="errorMsg" class="error-msg hidden"></p>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Dashboard Section -->
    <div id="dashboardSection" class="hidden">
        <div class="header">
            <h1>Tableau de Bord - Conception et Prototypage</h1>
            <div>
                <span id="adminName" style="margin-right: 20px; color: #aaa;"></span>
                <button class="btn btn-logout" onclick="logout()">D√©connexion</button>
            </div>
        </div>
        
        <div class="container">
            <!-- Stats Cards -->
            <div class="stats-grid">
                <div class="stat-card">
                    <h3 id="statEtudiants">0</h3>
                    <p>√âtudiants inscrits</p>
                </div>
                <div class="stat-card">
                    <h3 id="statExamens">0</h3>
                    <p>Examens pass√©s</p>
                </div>
                <div class="stat-card">
                    <h3 id="statTaux">0%</h3>
                    <p>Taux de compl√©tion</p>
                </div>
                <div class="stat-card">
                    <h3 id="statMoyenne">-</h3>
                    <p>Moyenne g√©n√©rale</p>
                </div>
            </div>
            
            <!-- Tabs -->
            <div class="tabs">
                <button class="tab active" onclick="showTab('etudiants')">√âtudiants</button>
                <button class="tab" onclick="showTab('resultats')">R√©sultats</button>
                <button class="tab" onclick="showTab('matieres')">Par Mati√®re</button>
                <button class="tab" onclick="showTab('filieres')">Par Fili√®re</button>
                <button class="btn" style="margin-left: auto; background: #27ae60; color: white;" onclick="exportCSV()">üì• Exporter CSV</button>
            </div>
            
            <!-- Tab: √âtudiants -->
            <div id="tabEtudiants" class="section">
                <h2>Liste des √âtudiants</h2>
                
                <div style="margin-bottom: 15px;">
                    <button class="btn" style="background: #e74c3c; padding: 10px 20px; font-size: 14px;" onclick="envoyerTousLesEmails()">
                        üìß Envoyer les emails √† TOUS les √©tudiants
                    </button>
                    <span id="emailProgress" style="margin-left: 15px; font-weight: bold;"></span>
                </div>
                
                <div class="filters">
                    <input type="text" id="searchInput" placeholder="Rechercher un √©tudiant..." oninput="filterTable()">
                    <select id="filterFiliere" onchange="filterTable()">
                        <option value="">Toutes les fili√®res</option>
                    </select>
                    <select id="filterAnnee" onchange="filterTable()">
                        <option value="">Toutes les ann√©es</option>
                    </select>
                    <select id="filterStatut" onchange="filterTable()">
                        <option value="">Tous les statuts</option>
                        <option value="complet">Examens complets</option>
                        <option value="partiel">En cours</option>
                        <option value="aucun">Aucun examen</option>
                    </select>
                </div>
                
                <div class="table-container">
                    <table id="etudiantsTable">
                        <thead>
                            <tr>
                                <th>Nom</th>
                                <th>Pr√©nom</th>
                                <th>Fili√®re</th>
                                <th>Ann√©e</th>
                                <th>Progression</th>
                                <th>Examens</th>
                                <th>Email</th>
                            </tr>
                        </thead>
                        <tbody id="etudiantsBody">
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Tab: R√©sultats -->
            <div id="tabResultats" class="section hidden">
                <h2>R√©sultats des Examens</h2>
                <div class="filters">
                    <input type="text" id="searchResultat" placeholder="Rechercher..." oninput="filterResultats()">
                    <select id="filterFiliereResultat" onchange="filterResultats()">
                        <option value="">Toutes les fili√®res</option>
                    </select>
                </div>
                <div class="table-container" style="max-height: 600px; overflow-y: auto;">
                    <table id="resultatsTable">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>√âtudiant</th>
                                <th>Fili√®re</th>
                                <th>Mati√®re</th>
                                <th>Score</th>
                                <th>Note</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="resultatsBody">
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Tab: Mati√®res -->
            <div id="tabMatieres" class="section hidden">
                <h2>Statistiques par Mati√®re</h2>
                <div class="progress-grid" id="matieresGrid">
                </div>
            </div>
            
            <!-- Tab: Fili√®res -->
            <div id="tabFilieres" class="section hidden">
                <h2>Statistiques par Fili√®re</h2>
                <div class="progress-grid" id="filieresGrid">
                </div>
            </div>
        </div>
    </div>
    
    <script>
        let dashboardData = null;
        
        // V√©rifier la session au chargement
        document.addEventListener('DOMContentLoaded', checkSession);
        
        async function checkSession() {
            try {
                const res = await fetch('/api/session');
                const data = await res.json();
                
                if (data.loggedIn && data.user.annee === 'Admin') {
                    showDashboard(data.user);
                } else {
                    showLogin();
                }
            } catch (e) {
                showLogin();
            }
        }
        
        // Login
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const login = document.getElementById('login').value;
            const password = document.getElementById('password').value;
            const errorMsg = document.getElementById('errorMsg');
            
            try {
                const res = await fetch('/api/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ login, password })
                });
                
                const data = await res.json();
                
                if (data.success && data.user.annee === 'Admin') {
                    showDashboard(data.user);
                } else if (data.success) {
                    errorMsg.textContent = 'Acc√®s r√©serv√© aux administrateurs';
                    errorMsg.classList.remove('hidden');
                } else {
                    errorMsg.textContent = data.error || 'Erreur de connexion';
                    errorMsg.classList.remove('hidden');
                }
            } catch (e) {
                errorMsg.textContent = 'Erreur de connexion au serveur';
                errorMsg.classList.remove('hidden');
            }
        });
        
        function showLogin() {
            document.getElementById('loginSection').classList.remove('hidden');
            document.getElementById('dashboardSection').classList.add('hidden');
        }
        
        async function showDashboard(user) {
            document.getElementById('loginSection').classList.add('hidden');
            document.getElementById('dashboardSection').classList.remove('hidden');
            document.getElementById('adminName').textContent = `${user.prenom} ${user.nom}`;
            
            await loadDashboard();
        }
        
        async function loadDashboard() {
            try {
                const res = await fetch('/api/admin/dashboard');
                dashboardData = await res.json();
                
                // Charger les identifiants pour l'envoi d'emails
                await loadCredentials();
                
                renderStats();
                renderEtudiants();
                renderMatieres();
                renderFilieres();
                populateFilters();
            } catch (e) {
                console.error('Erreur chargement dashboard:', e);
            }
        }
        
        function renderStats() {
            document.getElementById('statEtudiants').textContent = dashboardData.totalEtudiants;
            document.getElementById('statExamens').textContent = dashboardData.totalExamensPass√©s;
            
            // Calculer le taux de compl√©tion global
            let totalExamensAttendus = 0;
            dashboardData.etudiants.forEach(e => totalExamensAttendus += e.totalExamens);
            const taux = totalExamensAttendus > 0 
                ? Math.round((dashboardData.totalExamensPass√©s / totalExamensAttendus) * 100) 
                : 0;
            document.getElementById('statTaux').textContent = taux + '%';
            
            // Calculer la moyenne g√©n√©rale
            let totalNotes = 0;
            let countNotes = 0;
            Object.values(dashboardData.parMatiere).forEach(m => {
                m.notes.forEach(n => {
                    totalNotes += n;
                    countNotes++;
                });
            });
            const moyenne = countNotes > 0 ? (totalNotes / countNotes).toFixed(2) : '-';
            document.getElementById('statMoyenne').textContent = moyenne;
        }
        
        function renderEtudiants() {
            const tbody = document.getElementById('etudiantsBody');
            tbody.innerHTML = '';
            
            dashboardData.etudiants.forEach(etudiant => {
                const tr = document.createElement('tr');
                tr.dataset.filiere = etudiant.filiere;
                tr.dataset.annee = etudiant.annee;
                tr.dataset.nom = etudiant.nom.toLowerCase();
                tr.dataset.prenom = etudiant.prenom.toLowerCase();
                tr.dataset.progression = etudiant.progression;
                
                // D√©terminer le statut
                let statut = 'aucun';
                if (etudiant.progression === 100) statut = 'complet';
                else if (etudiant.progression > 0) statut = 'partiel';
                tr.dataset.statut = statut;
                
                // Cr√©er les badges d'examens
                let examensHtml = '<div class="examen-status">';
                etudiant.examens.forEach(ex => {
                    const classe = ex.passe ? 'examen-passe' : 'examen-non-passe';
                    const noteText = ex.passe ? ` (${ex.note})` : '';
                    examensHtml += `<span class="examen-badge ${classe}" title="${ex.matiere}">${ex.matiere.substring(0, 15)}...${noteText}</span>`;
                });
                examensHtml += '</div>';
                
                // Couleur de la progression
                let progressClass = 'note-poor';
                if (etudiant.progression === 100) progressClass = 'note-excellent';
                else if (etudiant.progression > 0) progressClass = 'note-good';
                
                tr.innerHTML = `
                    <td><strong>${etudiant.nom}</strong></td>
                    <td>${etudiant.prenom}</td>
                    <td><span class="badge badge-info">${etudiant.filiere}</span></td>
                    <td>${etudiant.annee}</td>
                    <td class="${progressClass}">${etudiant.progression}% (${etudiant.examensPass√©s}/${etudiant.totalExamens})</td>
                    <td>${examensHtml}</td>
                    <td>
                        <button class="btn" style="padding: 5px 8px; background: #3498db; color: white; font-size: 11px; margin-right: 5px;" onclick="modifierEtudiant('${etudiant.login}')">‚úèÔ∏è Modifier</button>
                        <button class="btn" style="padding: 5px 8px; background: #9b59b6; color: white; font-size: 11px;" onclick="envoyerEmail('${etudiant.login}')">üìß Email</button>
                    </td>
                `;
                
                tbody.appendChild(tr);
            });
        }
        
        function renderMatieres() {
            const grid = document.getElementById('matieresGrid');
            grid.innerHTML = '';
            
            Object.entries(dashboardData.parMatiere).forEach(([matiere, data]) => {
                const pct = data.total > 0 ? Math.round((data.passes / data.total) * 100) : 0;
                const moyenneText = data.moyenne !== null ? `Moyenne: ${data.moyenne}/20` : 'Aucune note';
                
                grid.innerHTML += `
                    <div class="progress-item">
                        <h4>${matiere}</h4>
                        <p style="color: #aaa; font-size: 12px; margin-bottom: 8px;">${data.passes}/${data.total} √©tudiants - ${moyenneText}</p>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${pct}%"></div>
                            <span class="progress-text">${pct}%</span>
                        </div>
                    </div>
                `;
            });
        }
        
        function renderFilieres() {
            const grid = document.getElementById('filieresGrid');
            grid.innerHTML = '';
            
            Object.entries(dashboardData.parFiliere).forEach(([filiere, data]) => {
                const pct = data.total > 0 ? Math.round((data.passes / data.total) * 100) : 0;
                
                grid.innerHTML += `
                    <div class="progress-item">
                        <h4>${filiere}</h4>
                        <p style="color: #aaa; font-size: 12px; margin-bottom: 8px;">${data.passes}/${data.total} examens pass√©s</p>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${pct}%"></div>
                            <span class="progress-text">${pct}%</span>
                        </div>
                    </div>
                `;
            });
        }
        
        function populateFilters() {
            const filieres = new Set();
            const annees = new Set();
            
            dashboardData.etudiants.forEach(e => {
                filieres.add(e.filiere);
                annees.add(e.annee);
            });
            
            const filterFiliere = document.getElementById('filterFiliere');
            filieres.forEach(f => {
                filterFiliere.innerHTML += `<option value="${f}">${f}</option>`;
            });
            
            const filterAnnee = document.getElementById('filterAnnee');
            annees.forEach(a => {
                filterAnnee.innerHTML += `<option value="${a}">${a}</option>`;
            });
        }
        
        function filterTable() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            const filiere = document.getElementById('filterFiliere').value;
            const annee = document.getElementById('filterAnnee').value;
            const statut = document.getElementById('filterStatut').value;
            
            const rows = document.querySelectorAll('#etudiantsBody tr');
            
            rows.forEach(row => {
                const matchSearch = row.dataset.nom.includes(search) || row.dataset.prenom.includes(search);
                const matchFiliere = !filiere || row.dataset.filiere === filiere;
                const matchAnnee = !annee || row.dataset.annee === annee;
                const matchStatut = !statut || row.dataset.statut === statut;
                
                row.style.display = (matchSearch && matchFiliere && matchAnnee && matchStatut) ? '' : 'none';
            });
        }
        
        function showTab(tabName) {
            // Masquer tous les onglets
            document.getElementById('tabEtudiants').classList.add('hidden');
            document.getElementById('tabResultats').classList.add('hidden');
            document.getElementById('tabMatieres').classList.add('hidden');
            document.getElementById('tabFilieres').classList.add('hidden');
            
            // D√©sactiver tous les boutons
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            
            // Afficher l'onglet s√©lectionn√©
            if (tabName === 'etudiants') {
                document.getElementById('tabEtudiants').classList.remove('hidden');
                document.querySelectorAll('.tab')[0].classList.add('active');
            } else if (tabName === 'resultats') {
                document.getElementById('tabResultats').classList.remove('hidden');
                document.querySelectorAll('.tab')[1].classList.add('active');
                loadResultats();
            } else if (tabName === 'matieres') {
                document.getElementById('tabMatieres').classList.remove('hidden');
                document.querySelectorAll('.tab')[2].classList.add('active');
            } else if (tabName === 'filieres') {
                document.getElementById('tabFilieres').classList.remove('hidden');
                document.querySelectorAll('.tab')[3].classList.add('active');
            }
        }
        
        let resultatsData = [];
        
        async function loadResultats() {
            try {
                const res = await fetch('/api/admin/resultats');
                resultatsData = await res.json();
                renderResultats();
                populateResultatsFilters();
            } catch (e) {
                console.error('Erreur chargement r√©sultats:', e);
            }
        }
        
        function renderResultats() {
            const tbody = document.getElementById('resultatsBody');
            tbody.innerHTML = '';
            
            if (resultatsData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #aaa;">Aucun r√©sultat disponible</td></tr>';
                return;
            }
            
            resultatsData.forEach(r => {
                const tr = document.createElement('tr');
                tr.dataset.nom = (r.nom || '').toLowerCase();
                tr.dataset.prenom = (r.prenom || '').toLowerCase();
                tr.dataset.filiere = r.filiere || '';
                
                const date = new Date(r.date).toLocaleString('fr-FR');
                const noteClass = r.note >= 14 ? 'note-excellent' : (r.note >= 10 ? 'note-good' : 'note-poor');
                
                tr.innerHTML = `
                    <td>${date}</td>
                    <td><strong>${r.nom}</strong> ${r.prenom}</td>
                    <td><span class="badge badge-info">${r.filiere}</span></td>
                    <td>${r.matiere}</td>
                    <td>${r.score}/${r.total}</td>
                    <td class="${noteClass}"><strong>${r.note}/20</strong></td>
                    <td><button class="btn" style="padding: 5px 10px; background: #3498db; color: white; font-size: 12px;" onclick="voirDetails('${r.login}')">D√©tails</button></td>
                `;
                
                tbody.appendChild(tr);
            });
        }
        
        function populateResultatsFilters() {
            const filieres = new Set();
            resultatsData.forEach(r => {
                if (r.filiere) filieres.add(r.filiere);
            });
            
            const filterFiliere = document.getElementById('filterFiliereResultat');
            filterFiliere.innerHTML = '<option value="">Toutes les fili√®res</option>';
            filieres.forEach(f => {
                filterFiliere.innerHTML += `<option value="${f}">${f}</option>`;
            });
        }
        
        function filterResultats() {
            const search = document.getElementById('searchResultat').value.toLowerCase();
            const filiere = document.getElementById('filterFiliereResultat').value;
            
            const rows = document.querySelectorAll('#resultatsBody tr');
            
            rows.forEach(row => {
                if (!row.dataset.nom) return;
                const matchSearch = row.dataset.nom.includes(search) || row.dataset.prenom.includes(search);
                const matchFiliere = !filiere || row.dataset.filiere === filiere;
                
                row.style.display = (matchSearch && matchFiliere) ? '' : 'none';
            });
        }
        
        async function voirDetails(login) {
            try {
                const res = await fetch(`/api/admin/etudiant/${login}`);
                const data = await res.json();
                
                let html = `<h3>√âtudiant: ${data.etudiant?.nom || ''} ${data.etudiant?.prenom || ''}</h3>`;
                html += `<p>Fili√®re: ${data.etudiant?.filiere || ''} - ${data.etudiant?.annee || ''}</p><hr>`;
                
                if (data.examens && data.examens.length > 0) {
                    data.examens.forEach(exam => {
                        html += `<h4>${exam.matiere} - Note: ${exam.note}/20</h4>`;
                        html += `<p>Date: ${new Date(exam.date).toLocaleString('fr-FR')}</p>`;
                        html += `<p>Score: ${exam.score}/${exam.total}</p>`;
                        if (exam.corrections && exam.corrections.length > 0) {
                            html += '<table style="width:100%; margin: 10px 0; font-size: 12px;">';
                            html += '<tr><th>Q</th><th>R√©ponse</th><th>Correct</th></tr>';
                            exam.corrections.forEach(c => {
                                const icon = c.correct ? '‚úÖ' : '‚ùå';
                                html += `<tr><td>${c.numero}</td><td>${c.reponseEtudiant || '-'}</td><td>${icon}</td></tr>`;
                            });
                            html += '</table>';
                        }
                        html += '<hr>';
                    });
                } else {
                    html += '<p>Aucun examen pass√©</p>';
                }
                
                alert(html.replace(/<[^>]*>/g, '\n').substring(0, 2000));
            } catch (e) {
                console.error('Erreur:', e);
            }
        }
        
        function exportCSV() {
            window.location.href = '/api/admin/export-csv';
        }
        
        let credentialsData = {};
        
        async function loadCredentials() {
            try {
                const res = await fetch('/api/admin/credentials');
                const data = await res.json();
                data.forEach(c => {
                    credentialsData[c.login] = c;
                });
            } catch (e) {
                console.error('Erreur chargement credentials:', e);
            }
        }
        
        async function modifierEtudiant(login) {
            const cred = credentialsData[login];
            if (!cred) {
                alert('√âtudiant non trouv√©');
                return;
            }
            
            // Cr√©er un formulaire modal
            const currentEmail = cred.email || '';
            const currentPassword = cred.password || '';
            
            const newEmail = prompt(`Email actuel: ${currentEmail}\n\nNouveau email (laisser vide pour ne pas modifier):`, currentEmail);
            if (newEmail === null) return; // Annul√©
            
            const newPassword = prompt(`Mot de passe actuel: ${currentPassword}\n\nNouveau mot de passe (laisser vide pour ne pas modifier):`, '');
            if (newPassword === null) return; // Annul√©
            
            if (!newEmail && !newPassword) {
                alert('Aucune modification effectu√©e');
                return;
            }
            
            try {
                const res = await fetch('/api/admin/update-student', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({
                        login: login,
                        newEmail: newEmail || undefined,
                        newPassword: newPassword || undefined
                    })
                });
                
                const data = await res.json();
                
                if (data.success) {
                    alert('‚úÖ Informations mises √† jour avec succ√®s !');
                    // Mettre √† jour les donn√©es locales
                    if (newEmail) credentialsData[login].email = newEmail;
                    if (newPassword) credentialsData[login].password = newPassword;
                } else {
                    alert('Erreur: ' + (data.error || 'Erreur inconnue'));
                }
            } catch (e) {
                alert('Erreur de connexion au serveur');
            }
        }
        
        async function envoyerEmail(login) {
            const cred = credentialsData[login];
            if (!cred) {
                alert('Identifiants non trouv√©s pour cet √©tudiant');
                return;
            }
            
            if (!cred.email) {
                alert('Email non disponible pour cet √©tudiant');
                return;
            }
            
            // Confirmer l'envoi
            if (!confirm(`Envoyer l'email √† ${cred.nom} ${cred.prenom} (${cred.email}) ?`)) {
                return;
            }
            
            // Afficher un message de chargement
            const btn = event.target;
            const originalText = btn.innerHTML;
            btn.innerHTML = '‚è≥...';
            btn.disabled = true;
            
            try {
                const res = await fetch('/api/admin/send-email', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({
                        email: cred.email,
                        nom: cred.nom,
                        prenom: cred.prenom,
                        login: cred.login,
                        password: cred.password
                    })
                });
                
                const data = await res.json();
                
                if (data.success) {
                    btn.innerHTML = '‚úÖ Envoy√©';
                    btn.style.background = '#27ae60';
                    setTimeout(() => {
                        btn.innerHTML = originalText;
                        btn.style.background = '#9b59b6';
                        btn.disabled = false;
                    }, 3000);
                } else if (data.useMailto) {
                    // Fallback vers mailto si pas de config email
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                    
                    const m = data.mailto;
                    const subject = encodeURIComponent('Convocation Examen Conception et Prototypage - ENSAM Casablanca');
                    const body = encodeURIComponent(`Cher(e) ${m.nom} ${m.prenom},

Vous √™tes invit√©(e) √† passer votre examen en ligne sur la plateforme d'examens de l'ENSAM Casablanca.

üîó Lien de la plateforme :
https://examcadprotoensam.onrender.com/

üîê Vos identifiants de connexion :
- Login : ${m.login}
- Mot de passe : ${m.password}

üìã Instructions :
1. Acc√©dez √† la plateforme via le lien ci-dessus
2. Connectez-vous avec vos identifiants personnels
3. S√©lectionnez l'examen √† passer
4. L'examen contient 20 questions et dure 30 minutes
5. Votre note sera affich√©e imm√©diatement apr√®s la soumission

‚ö†Ô∏è Important :
- Vous n'avez droit qu'√† une seule tentative par examen
- Une fois commenc√©, le chronom√®tre ne peut pas √™tre arr√™t√©
- Assurez-vous d'avoir une connexion internet stable
- Ne fermez pas votre navigateur pendant l'examen

üìÖ DATE LIMITE DE PASSAGE :
üî¥ Jeudi 16 Janvier 2026 √† MINUIT (00h00)
Aucune soumission ne sera accept√©e apr√®s cette date.

Pour toute question technique, veuillez contacter votre responsable de fili√®re.

Bonne chance !`);
                    
                    window.open(`mailto:${m.email}?subject=${subject}&body=${body}`, '_blank');
                } else {
                    alert('Erreur: ' + (data.error || 'Erreur inconnue'));
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }
            } catch (e) {
                alert('Erreur de connexion au serveur');
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }
        
        async function envoyerTousLesEmails() {
            if (!confirm('‚ö†Ô∏è √ätes-vous s√ªr de vouloir envoyer les emails √† TOUS les √©tudiants (61 emails) ?\n\nCette action peut prendre plusieurs minutes.')) {
                return;
            }
            
            const progressSpan = document.getElementById('emailProgress');
            progressSpan.innerHTML = '‚è≥ Envoi en cours...';
            progressSpan.style.color = '#f39c12';
            
            try {
                const res = await fetch('/api/admin/send-all-emails', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include'
                });
                
                const data = await res.json();
                
                if (data.success) {
                    progressSpan.innerHTML = `‚úÖ ${data.sent} emails envoy√©s, ${data.failed} √©checs`;
                    progressSpan.style.color = data.failed > 0 ? '#e74c3c' : '#27ae60';
                    
                    if (data.errors && data.errors.length > 0) {
                        alert('Envoi termin√© avec des erreurs:\n\n' + data.errors.join('\n'));
                    } else {
                        alert('‚úÖ Tous les emails ont √©t√© envoy√©s avec succ√®s !');
                    }
                } else {
                    progressSpan.innerHTML = '‚ùå Erreur';
                    progressSpan.style.color = '#e74c3c';
                    alert('Erreur: ' + (data.error || 'Erreur inconnue'));
                }
            } catch (e) {
                progressSpan.innerHTML = '‚ùå Erreur de connexion';
                progressSpan.style.color = '#e74c3c';
                alert('Erreur de connexion au serveur');
            }
        }
        
        async function logout() {
            await fetch('/api/logout', { method: 'POST' });
            showLogin();
            document.getElementById('login').value = '';
            document.getElementById('password').value = '';
        }
    </script>
</body>
</html>
